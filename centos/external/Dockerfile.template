FROM espa/base:ESPA_VERSION


MAINTAINER USGS EROS LSRD http://eros.usgs.gov


LABEL description="External software we use installed into the image as well as additional CENTOS repo packages required for building and executing ESPA-Product-Fulfillment."


# Compilers and all the rquired libraries
RUN yum groupinstall -y "Development Tools" \
    && yum install -y \
        glibc-static-2.12-1.209.el6_9.2.x86_64 \
        e2fsprogs-1.41.12-23.el6.x86_64 \
        libcurl-devel-7.19.7-53.el6_9.x86_64 \
        expat-devel-2.0.1-13.el6_8.x86_64 \
        freetype-devel-2.3.11-17.el6.x86_64 \
        zlib-static-1.2.3-29.el6.x86_64 \
        e2fsprogs-libs-1.41.12-23.el6.x86_64 \
        wget-1.12-10.el6.x86_64 \
        glibc-static-2.12-1.209.el6_9.2.i686 \
        perl-ExtUtils-MakeMaker-6.55-144.el6.x86_64 \
        libpng-devel-1.2.49-2.el6_7.x86_64 \
        libidn-devel-1.18-2.el6.x86_64 \
        zlib-devel-1.2.3-29.el6.x86_64 \
        autoconf-2.63-5.1.el6.noarch \
        automake-1.11.1-4.el6.noarch \
        binutils-2.20.51.0.2-5.47.el6_9.1.x86_64 \
        bison-2.4.1-5.el6.x86_64 \
        flex-2.5.35-9.el6.x86_64 \
        gcc-4.4.7-18.el6.x86_64 \
        gcc-c++-4.4.7-18.el6.x86_64 \
        gettext-0.17-18.el6.x86_64 \
        libtool-2.2.6-15.5.el6.x86_64 \
        make-3.81-23.el6.x86_64 \
        patch-2.6-6.el6.x86_64 \
        pkgconfig-0.23-9.1.el6.x86_64 \
        redhat-rpm-config-9.0.3-51.el6.centos.noarch \
        rpm-build-4.8.0-55.el6.x86_64 \
        byacc-1.9.20070509-7.el6.x86_64 \
        cvs-1.11.23-16.el6.x86_64 \
        diffstat-1.51-2.el6.x86_64 \
        elfutils-0.164-2.el6.x86_64 \
        gcc-gfortran-4.4.7-18.el6.x86_64 \
        git-1.7.1-9.el6_9.x86_64 \
        indent-2.2.10-7.el6.x86_64 \
        patchutils-0.3.1-3.1.el6.x86_64 \
        subversion-1.6.11-15.el6_7.x86_64 \
        systemtap-2.9-7.el6.x86_64 \
        bzr-2.1.1-2.el6.x86_64 \
        compat-gcc-34-3.4.6-19.el6.x86_64 \
        compat-gcc-34-c++-3.4.6-19.el6.x86_64 \
        compat-gcc-34-g77-3.4.6-19.el6.x86_64 \
        expect-5.44.1.15-5.el6_4.x86_64 \
        lua-5.1.4-4.1.el6.x86_64 \
        mercurial-1.4-5.el6_9.x86_64 \
        rpmdevtools-7.5-2.el6.noarch \
    && yum clean metadata


# Update git to a version that isn't broken
RUN cd /usr/local/src \
    && git clone \
        --depth 1 \
        --branch v2.9.2 \
        https://github.com/git/git.git git.git \
    && cd git.git \
    && make configure \
    && ./configure --without-tcltk \
    && make -j4 \
    && make install \
    && cd .. \
    && rm -rf git.git


# Source and installation locations
ENV PREFIX=/usr/local \
    SRC_DIR=/usr/local/src \
    ZLIB_PREFIX=/usr/local \
    XZ_PREFIX=/usr/local \
    SZIP_PREFIX=/usr/local \
    PNG_PREFIX=/usr/local \
    FREETYPE2_PREFIX=/usr/local \
    XML2_PREFIX=/usr/local \
    XSLT_PREFIX=/usr/local \
    IDN_PREFIX=/usr/local/idn \
    CURL_PREFIX=/usr/local/curl \
    JPEG_PREFIX=/usr/local \
    JBIG_PREFIX=/usr/local \
    TIFF_PREFIX=/usr/local \
    GEOTIFF_PREFIX=/usr/local \
    HDF4_PREFIX=/usr/local \
    HDF5_PREFIX=/usr/local \
    NETCDF4_PREFIX=/usr/local \
    HDFEOS_PREFIX=/usr/local \
    PROJ4_PREFIX=/usr/local \
    GDAL_PREFIX=/usr/local


# Include and library paths
ENV ZLIBINC=$ZLIB_PREFIX/include \
    ZLIBLIB=$ZLIB_PREFIX/lib \
    XZINC=$XZ_PREFIX/include \
    XZLIB=$XZ_PREFIX/lib \
    LZMAINC=$XZ_PREFIX/include \
    LZMALIB=$XZ_PREFIX/lib \
    SZIPINC=$SZIP_PREFIX/include \
    SZIPLIB=$SZIP_PREFIX/lib \
    PNGINC=$PNG_PREFIX/include \
    PNGLIB=$PNG_PREFIX/lib \
    FREETYPE2INC=$FREETYPE2_PREFIX/include \
    FREETYPE2LIB=$FREETYPE2_PREFIX/lib \
    XML2INC=$XML2_PREFIX/include/libxml2 \
    XML2LIB=$XML2_PREFIX/lib \
    XSLTINC=$XSLT_PREFIX/include/libxslt \
    XSLTLIB=$XSLT_PREFIX/lib \
    IDNINC=$IDN_PREFIX/include \
    IDNLIB=$IDN_PREFIX/lib \
    CURLINC=$CURL_PREFIX/include \
    CURLLIB=$CURL_PREFIX/lib \
    JPEGINC=$JPEG_PREFIX/include \
    JPEGLIB=$JPEG_PREFIX/lib \
    JBIGINC=$JBIG_PREFIX/include \
    JBIGLIB=$JBIG_PREFIX/lib \
    TIFFINC=$TIFF_PREFIX/include \
    TIFFLIB=$TIFF_PREFIX/lib \
    GEOTIFFINC=$GEOTIFF_PREFIX/include \
    GEOTIFFLIB=$GEOTIFF_PREFIX/lib \
    GEOTIFF_INC=$GEOTIFF_PREFIX/include \
    GEOTIFF_LIB=$GEOTIFF_PREFIX/lib \
    HDFINC=$HDF4_PREFIX/include \
    HDFLIB=$HDF4_PREFIX/lib \
    HDF4INC=$HDF4_PREFIX/include \
    HDF4LIB=$HDF4_PREFIX/lib \
    HDF5INC=$HDF5_PREFIX/include \
    HDF5LIB=$HDF5_PREFIX/lib \
    NCDF4INC=$NETCDF4_PREFIX/include \
    NCDF4LIB=$NETCDF4_PREFIX/lib \
    NETCDF4INC=$NETCDF4_PREFIX/include \
    NETCDF4LIB=$NETCDF4_PREFIX/lib \
    HDFEOSINC=$HDFEOS_PREFIX/include \
    HDFEOSLIB=$HDFEOS_PREFIX/lib \
    HDFEOS_INC=$HDFEOS_PREFIX/include \
    HDFEOS_LIB=$HDFEOS_PREFIX/lib \
    HDFEOS_GCTPINC=$HDFEOS_PREFIX/include \
    HDFEOS_GCTPLIB=$HDFEOS_PREFIX/lib \
    PROJ4_INC=$PROJ4_PREFIX/include \
    PROJ4_LIB=$PROJ4_PREFIX/lib \
    GDAL_INC=$GDAL_PREFIX/include \
    GDAL_LIB=$GDAL_PREFIX/lib


# Needed for python to find installed shared libraries
# May also solve some hdfeos issues
ENV LD_LIBRARY_PATH=/usr/lib64:/usr/local/lib


# Install OpenSSL (required by python-pip)
COPY external_tools/openssl-1.0.1e.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && gzip -d < openssl-1.0.1e.tar.gz > openssl-1.0.1e.tar \
    && tar -xvf openssl-1.0.1e.tar \
    && cd openssl-1.0.1e \
    && ./config enable-shared \
    && make \
    && make install \
    && cd $SRC_DIR \
    && rm -Rf openssl-1.0.1e openssl-1.0.1e.tar.gz openssl-1.0.1e.tar
ENV LD_LIBRARY_PATH=/usr/local/ssl/lib:${LD_LIBRARY_PATH}


# Install Python
COPY external_tools/Python-2.7.8.tgz $SRC_DIR
RUN cd $SRC_DIR \
    && ls ./* \
    && gzip -d < Python-2.7.8.tgz > Python-2.7.8.tar \
    && tar -xvf Python-2.7.8.tar \
    && cd Python-2.7.8 \
    && ./configure --prefix=/usr/local/python-espa --with-ssl=/usr/local/ssl --enable-shared \
    && make -j 4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf Python-2.7.8.tgz Python-2.7.8 Python-2.7.8.tar


ENV LD_LIBRARY_PATH=/usr/local/python-espa/lib:${LD_LIBRARY_PATH}
ENV ESPA_PYTHON_INSTALL=/usr/local/python-espa/lib
ENV PATH=/usr/local/python-espa/bin:${PATH}


# Install Pip
COPY external_tools/get-pip.py $SRC_DIR
RUN cd $SRC_DIR \
    && python get-pip.py 'pip==7.1.0' --verbose \
    && rm get-pip.py


# Additional tools provided by the OS required for ESPA
#### RUN yum install -y \
####         wget \
####         wgrib \
####     && yum clean metadata


# Install xz to get the lzma library
COPY external_tools/xz-5.2.2.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf xz-5.2.2.tar.gz \
    && cd xz-5.2.2 \
    && ./configure --prefix=$XZ_PREFIX \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf xz-5.2.2 xz-5.2.2.tar.gz


# Install szip
COPY external_tools/szip-2.1.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf szip-2.1.tar.gz \
    && cd szip-2.1 \
    && ./configure --prefix=$SZIP_PREFIX \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf szip-2.1 szip-2.1.tar.gz


# Install libxml2
COPY external_tools/libxml2-2.9.3.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf libxml2-2.9.3.tar.gz \
    && cd libxml2-2.9.3 \
    && ./configure --prefix=$XML2_PREFIX \
        --with-zlib=$ZLIB_PREFIX \
        --with-lzma=$XZ_PREFIX \
        --with-python=$ESPA_PYTHON_INSTALL \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf libxml2-2.9.3 libxml2-2.9.3.tar.gz


# Install libxslt
COPY external_tools/libxslt-1.1.28.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf libxslt-1.1.28.tar.gz \
    && cd libxslt-1.1.28 \
    && ./configure --prefix=$XSLT_PREFIX \
        --with-libxml-libs-prefix=$XML2LIB \
        --with-python=$ESPA_PYTHON_INSTALL \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf libxslt-1.1.28 libxslt-1.1.28.tar.gz


# Install jpeg
# These are needed with jpeg-6b
#    && make install-lib \
#    && make install-headers \
#
COPY external_tools/jpegsrc.v9b.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf jpegsrc.v9b.tar.gz \
    && cd jpeg-9b \
    && ./configure --prefix=$JPEG_PREFIX \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf jpeg-9b jpegsrc.v9b.tar.gz


# Install jbigkit
COPY external_tools/jbigkit-2.1.tar.gz $SRC_DIR
COPY external_tools/jbigkit-2.1-Makefile $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf jbigkit-2.1.tar.gz \
    && cp jbigkit-2.1-Makefile jbigkit-2.1/Makefile \
    && cd jbigkit-2.1 \
    && make -j4 \
    && /usr/bin/install libjbig/libjbig.a $JBIGLIB/libjbig.a \
    && /usr/bin/install libjbig/libjbig85.a $JBIGLIB/libjbig85.a \
    && /usr/bin/install libjbig/*.h $JBIGINC \
    && cd $SRC_DIR \
    && rm -rf jbigkit-2.1 jbigkit-2.1.tar.gz jbigkit-2.1-Makefile


# Install proj4
COPY external_tools/proj-4.9.1.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf proj-4.9.1.tar.gz \
    && cd proj-4.9.1 \
    && ./configure --prefix=$PROJ4_PREFIX \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf proj-4.9.1 proj-4.9.1.tar.gz


# Install tiff
COPY external_tools/tiff-4.0.6.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf tiff-4.0.6.tar.gz \
    && cd tiff-4.0.6 \
    && ./configure --prefix=$TIFF_PREFIX \
        --with-jpeg-include-dir=$JPEGINC \
        --with-jpeg-lib-dir=$JPEGLIB \
        --with-jbig-include-dir=$JBIGINC \
        --with-jbig-lib-dir=$JBIGLIB \
        --with-zlib-include-dir=$ZLIBINC \
        --with-zlib-lib-dir=$ZLIBLIB \
        --with-lzma-include-dir=$LZMAINC \
        --with-lzma-lib-dir=$LZMALIB \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf tiff-4.0.6 tiff-4.0.6.tar.gz


# Install libgeotiff
COPY external_tools/libgeotiff-1.4.1.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf libgeotiff-1.4.1.tar.gz \
    && cd libgeotiff-1.4.1 \
    && ./configure --prefix=$GEOTIFF_PREFIX \
        --with-jpeg-include-dir=$JPEGINC \
        --with-jpeg-lib-dir=$JPEGLIB \
        --with-zlib-include-dir=$ZLIBINC \
        --with-zlib-lib-dir=$ZLIBLIB \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf libgeotiff-1.4.1 libgeotiff-1.4.1.tar.gz


# Install curl
COPY external_tools/curl-7.48.0.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf curl-7.48.0.tar.gz \
    && cd curl-7.48.0 \
    && ./configure --prefix=$CURL_PREFIX \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf curl-7.48.0 curl-7.48.0.tar.gz


# Install idn
COPY external_tools/libidn-1.32.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf libidn-1.32.tar.gz \
    && cd libidn-1.32 \
    && ./configure --prefix=$IDN_PREFIX \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf libidn-1.32 libidn-1.32.tar.gz


# Install HDF4
COPY external_tools/hdf-4.2.11.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf hdf-4.2.11.tar.gz \
    && cd hdf-4.2.11 \
    && ./configure --prefix=$HDF4_PREFIX \
        --with-jpeg=$JPEGLIB \
        --with-zlib=$ZLIBLIB \
        --with-szlib=$SZIPLIB \
        --disable-fortran \
        --disable-netcdf \
        --enable-shared \
        --enable-static \
        --enable-static-exec \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf hdf-4.2.11 hdf-4.2.11.tar.gz


# Install HDF5
COPY external_tools/hdf5-1.8.16.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf hdf5-1.8.16.tar.gz \
    && cd hdf5-1.8.16 \
    && ./configure --prefix=$HDF5_PREFIX \
        --with-jpeg=$JPEGINC,$JPEGLIB \
        --with-zlib=$ZLIBINC,$ZLIBLIB \
        --with-szlib=$SZIPINC,$SZIPLIB \
        --enable-threadsafe \
        --enable-unsupported \
        --with-pthread=/usr/lib64 \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf hdf5-1.8.16 hdf5-1.8.16.tar.gz


# Install netcdf-4
COPY external_tools/netcdf-4.4.0.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf netcdf-4.4.0.tar.gz \
    && cd netcdf-4.4.0 \
    && env CPPFLAGS="-I/usr/local/curl/include" LDFLAGS="-L/usr/local/curl/lib" \
        ./configure --prefix=$NETCDF4_PREFIX \
        --enable-netcdf-4 \
        --enable-shared \
        --enable-static \
    && make -j5 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf netcdf-4.4.0 netcdf-4.4.0.tar.gz


# Install HDFEOS2
COPY external_tools/HDF-EOS2.19v1.00.tar.Z $SRC_DIR
RUN cd $SRC_DIR \
    && gzip -d < HDF-EOS2.19v1.00.tar.Z > HDF-EOS2.19v1.00.tar \
    && tar -xvf HDF-EOS2.19v1.00.tar
RUN cd $SRC_DIR \
  && cd hdfeos \
  && ./configure --prefix=$HDFEOS_PREFIX \
        --with-jpeg=$JPEGLIB \
        --with-zlib=$ZLIBLIB \
        --with-szlib=$SZIPINC,$SZIPLIB \
        --enable-install-include \
        --disable-shared \
        --enable-static \
        CC="/usr/local/bin/h4cc -Df2cFortran" \
  && make -j4 \
  && make install \
  && cd $SRC_DIR \
  && rm -rf hdfeos HDF-EOS2.19v1.00.tar.Z HDF-EOS2.19v1.00.tar


# Python environment setup
# GDAL is installed into python through the below installation, because Numpy
# must be installed into python before building GDAL
RUN pip install --upgrade pip
RUN pip install \
        --global-option=build_ext \
        --global-option="-L/usr/local/lib" \
        --global-option="-I/usr/local/include" \
        --global-option="-I/usr/local/include/libxml2" \
        python-dateutil==1.5 \
        requests==2.4.3 \
        lxml==3.6.1


# Install linear algebra libraries to build SciPy (and NumPy)
RUN yum install -y \
    blas-3.2.1-5.el6.x86_64 \
    blas-devel-3.2.1-5.el6.x86_64 \
    atlas-3.8.4-2.el6.x86_64 \
    atlas-devel-3.8.4-2.el6.x86_64 \
    lapack-3.2.1-5.el6.x86_64 \
    lapack-devel-3.2.1-5.el6.x86_64


RUN GCC="-I/usr/local/python-espa/include/python2.7" \
    pip install \
        --global-option=build_ext \
        numpy==1.6.1

RUN pip install \
        --global-option=build_ext \
        scipy==0.11.0

RUN pip install \
        --global-option=build_ext \
        matplotlib==1.3.1 \
        tornado==3.1.1
# Force matplotlib to build the font cache
RUN python -c 'import matplotlib.pyplot'


# Install GDAL
COPY external_tools/gdal-1.11.4.tar.gz $SRC_DIR
RUN cd $SRC_DIR \
    && tar -xvf gdal-1.11.4.tar.gz \
    && cd gdal-1.11.4 \
    && ./configure --prefix=$GDAL_PREFIX \
        --with-liblzma \
        --with-python=/usr/local/python-espa/bin/python \
        --with-static-proj4=$PROJ4_LIB \
        --enable-shared \
        --enable-static \
    && make -j4 \
    && make install \
    && cd $SRC_DIR \
    && rm -rf gdal-1.11.4 gdal-1.11.4.tar.gz
